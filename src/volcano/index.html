<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Volcano assembler/disassembler</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/theme/volcano.css">
    <link rel="stylesheet" href="codemirror/addon/search/matchesonscrollbar.css">
    <link rel="stylesheet" href="vex/css/vex.css">
    <link rel="stylesheet" href="vex/css/vex-theme-volcano.css">
    <link rel="stylesheet" href="FindReplacePanel/FindReplacePanel.css">

    <script src="util/extend.js"></script>
    <script src="BigInteger/BigInteger.min.js"></script>
    <script src="FindReplacePanel/FindReplacePanel.js"></script>
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/addon/search/searchcursor.js"></script>
    <script src="codemirror/addon/search/matchesonscrollbar.js"></script>
    <script src="codemirror/addon/scroll/annotatescrollbar.js"></script>
    <script src="codemirror/mode/krakatau.js"></script>
</head>

<body>
    <div id="editor"></div>
    <div id="statusbar">
        <table>
            <tr>
                <td id="showlog">
                    <i id="showLogIcon" onclick = 'toggleLog()' title="Show log" class="fa fa-arrow-circle-o-up"></i>
                </td>
                <td id="message">Welcome to Volcano!</td>
                <td id="textpos"></td>
            </tr>
        </table>
    </div>
    <div id="log">
        <div id="logButtons">
            <input id="clearLogCmd" type="button" class="button" value="Clear" onclick = 'clearLog()'>
        </div>
        <div id="logContent"></div>
    </div>
</body>

<script>
    const rolling = 1200;
    const debug = false;
    let currentFilePath;
    let currentOutputPath;
    let dirty = false;
    let changeTimer;
    let messageElement = document.querySelector('#message');
    let textposElement = document.querySelector('#textpos');
    let logElement = document.querySelector('#log');
    let logContentElement = logElement.querySelector('#logContent');
    let showLogIconElement = document.querySelector('#showLogIcon');

    const vex = require('./vex/js/vex.combined.min.js');

    const {remote} = require('electron');

    const argFile = remote.getCurrentWindow().argFile;

    const {Menu, dialog, process} = remote;

    const system = process.platform + '-' + process.arch;

    const fs = remote.require('fs');

    const path = remote.require('path');

    const https = remote.require('https');

    const escapeHTML = require('./escape-html');

    const menu = Menu.buildFromTemplate([
        {
            label: 'File',
            submenu: [
                {label: 'New file', accelerator: 'CmdOrCtrl+N', click() {
                    newFile();
                }},
                {label: 'New window', accelerator: process.platform === 'darwin' ? 'Alt+Cmd+N' : 'Ctrl+Shift+N', click() {
                    remote.getGlobal('openFile')();
                }},
                {type: 'separator'},
                {label: 'Open file', accelerator: 'CmdOrCtrl+O', click(){
                    showLoadFileDialog(false);
                }},
                {label: 'Open file (New window)', accelerator: process.platform === 'darwin' ? 'Alt+Cmd+O' : 'Ctrl+Shift+O', click() {
                    showLoadFileDialog(true);
                }},
                {type: 'separator'},
                {label: 'Save file', accelerator: 'CmdOrCtrl+S', click(){
                    if (currentFilePath) {
                        saveFile(currentFilePath);
                    }
                    else showSaveFileDialog();
                }},
                {label: 'Save file as...', accelerator: process.platform === 'darwin' ? 'Alt+Cmd+S' : 'Ctrl+Shift+S', click(){
                    showSaveFileDialog();
                }},
                {type: 'separator'},
                {label: 'Disassemble folder', accelerator: 'CmdOrCtrl+G', click() { showDisassembleFolderDialog(false); }},
                {label: 'Disassemble folder recursively',accelerator: process.platform === 'darwin' ? 'Alt+Cmd+G' : 'Ctrl+Shift+G', click() { showDisassembleFolderDialog(true); }},
                {type: 'separator'},
                {label: 'Extract JAR', accelerator: process.platform === 'darwin' ? 'Alt+Cmd+E' : 'Ctrl+Shift+E', click(){ showExtractFileDialog(); }},
                {type: 'separator'},
                {label: 'Close', role: 'close'}
            ]
        },
        {
            label:'Edit',
            submenu:[
                { label: 'Undo',        accelerator: 'CmdOrCtrl+Z', role:'undo' },
                { label: 'Redo',        accelerator: 'CmdOrCtrl+Y', role:'redo' },
                { type: 'separator' },
                { label: 'Cut',         accelerator: 'CmdOrCtrl+X', role:'cut' },
                { label: 'Copy',        accelerator: 'CmdOrCtrl+C', role:'copy' },
                { label: 'Paste',       accelerator: 'CmdOrCtrl+V', role:'paste' },
                { label: 'Delete',      accelerator: 'CmdOrCtrl+D', role:'delete' },
                { type: 'separator' },
                { label: 'Find',        accelerator: 'CmdOrCtrl+F' ,
                    click() { findReplacePanel.open(false,editor.getSelection()); }
                },
                { label: 'Find and replace',
                    accelerator: process.platform === 'darwin' ? 'Alt+Cmd+F' : 'Ctrl+Shift+F' ,
                    click() { findReplacePanel.open(true,editor.getSelection()); }
                },
                { label: 'Select all',  accelerator: 'CmdOrCtrl+A',
                    click(){ editor.execCommand('selectAll'); }
                },
            ]
        },
        {
            label: 'Build',
            submenu: [
                {
                    label: 'Assemble', accelerator: 'F5', click(){
                        function doAsm() {
                            if (currentOutputPath) assemble(currentFilePath,currentOutputPath);
                            else {
                                dialog.showOpenDialog(
                                    remote.getCurrentWindow(),
                                    {
                                        title: 'Select assembler output folder (class files may be overwritten)',
                                        properties: ['openDirectory', 'createDirectory']
                                    },
                                    function (folderNames) {
                                        if (folderNames) {
                                            currentOutputPath = folderNames[0];
                                            assemble(currentFilePath, currentOutputPath);
                                        }
                                    }
                                );
                            }
                        }
                        if (currentFilePath) {
                            if (dirty) saveFile(currentFilePath);
                            doAsm();
                        }
                        else showSaveFileDialog(()=>{ if (currentFilePath) doAsm(); });
                    }
                },
                {
                    label: 'Assemble to...', accelerator: 'F6', click(){
                        function doAsmTo() {
                            dialog.showOpenDialog(
                                remote.getCurrentWindow(),
                                {
                                    title: 'Select assembler output folder (class files may be overwritten)',
                                    properties: ['openDirectory', 'createDirectory']
                                },
                                function (folderNames) {
                                    if (folderNames) {
                                        currentOutputPath = folderNames[0];
                                        assemble(currentFilePath, currentOutputPath);
                                    }
                                }
                            );
                        }
                        if (currentFilePath) {
                            if (dirty) saveFile(currentFilePath);
                            doAsmTo();
                        }
                        else showSaveFileDialog(()=>{ if (currentFilePath) doAsmTo(); });
                    }
                },
                {
                    label: 'Assemble folder', accelerator: 'F7', click(){
                        showAssembleFolderDialog(false);
                    },
                },
                {
                    label: 'Assemble folder recursively', accelerator: 'F8', click(){
                        showAssembleFolderDialog(true);
                    },
                },
            ]
        },
        {
            label:'View', submenu:[
                { label: 'Full Screen mode', accelerator:'F11', click(){
                    remote.getCurrentWindow().setFullScreen(!remote.getCurrentWindow().isFullScreen());
                    remote.getCurrentWindow().setMenuBarVisibility(true);
                }
                }
            ]
        },
        {
            label:'Help', submenu:[
                {
                    label: 'Check for updates', click() {
                        checkForUpdates(false);
                    }
                },
                {
                    label: 'About Volcano', click() {
                        showAlert(
                            '<span style="font-family:sourcecodeprobold">Volcano ' + formatVersion(rolling) + ' by Diego Vigorra</span><br>' +
                            'https://github.com/redking00/Volcano<br><br><hr>' +
                            'Krakatau Bytecode Tools by Robert Grosse<br>' +
                            'Copyright (C) 2012-17<br>'+
                            'https://github.com/Storyyeller/krakatau-js<br><br><hr>' +
                            'These programs are provided as open source under the GNU General Public License.<br>' +
                            'Visit https://www.gnu.org/licenses/gpl-3.0.txt for more details'
                        );
                    }
                }
            ]
        }
    ]);

    const contextMenu = Menu.buildFromTemplate([
        { label: 'Cut',         accelerator: 'CmdOrCtrl+X', role:'cut' },
        { label: 'Copy',        accelerator: 'CmdOrCtrl+C', role:'copy' },
        { label: 'Paste',       accelerator: 'CmdOrCtrl+V', role:'paste' },
        { label: 'Delete',      accelerator: 'CmdOrCtrl+D', role:'delete' },
        {type: 'separator'},
        { label: 'Find',        accelerator: 'CmdOrCtrl+F' ,
            click() {
                findReplacePanel.open(false,editor.getSelection());
            }
        },
        { label: 'Find and replace',
            accelerator: process.platform === 'darwin' ? 'Alt+Cmd+F' : 'Ctrl+Shift+F' ,
            click() { findReplacePanel.open(true,editor.getSelection()); }
        },
        { label: 'Select all',  accelerator: 'CmdOrCtrl+A',
            click(){ editor.execCommand('selectAll'); }
        },
    ]);

    const editor = CodeMirror(window.document.getElementById('editor'), {
        dragDrop:false,
        lineNumbers: true,
        styleActiveLine: true,
        gutters:['CodeMirror-linenumbers','gut-info'],
        indentWithTabs:false,
        extraKeys: {
            Tab: (cm) => {
                if (cm.somethingSelected()) {
                    cm.indentSelection("add");
                    return;
                }
                cm.execCommand("insertSoftTab");
            },
            "Shift-Tab": (cm) => {
                cm.indentSelection("subtract");
            }
        }
    });

    const findReplacePanel = new FindReplacePanel(editor);

    const updateURL = 'https://github.com/redking00/Volcano/raw/master/updates/' + system + '/';

    const workers = [];

    function formatVersion(rolling) {
        let rollingStr = ''+rolling;
        let min = rollingStr.slice(-3);
        let max = rollingStr.slice(0,rollingStr.length -3);
        return 'v.' + max + ' (build ' + min + ')';
    }

    function setDirty() {
        if (!dirty) {
            dirty = true;
            updateTitle();
            setStatusBarMessage(((currentFilePath)? currentFilePath:'Untitled.j') +' > Modified');
            editor.getMode().clearAsmErrors();
        }
    }

    function clearDirty() {
        dirty = false;
        updateTitle();
        editor.getMode().clearAsmErrors();
    }

    function setStatusBarMessage(msg, isError) {
        let time = new Date();
        let timeStr =
            ("0" + time.getHours()).slice(-2)   + ":" +
            ("0" + time.getMinutes()).slice(-2) + ":" +
            ("0" + time.getSeconds()).slice(-2) + "." +
            ("00" + time.getMilliseconds()).slice(-3);
        messageElement.innerText = timeStr + ' > ' + msg;
        addLogEntry(msg, isError);

    }

    function addLogEntry(msg, isError) {
        let time = new Date();
        let timeStr =
            ("0" + time.getHours()).slice(-2)   + ":" +
            ("0" + time.getMinutes()).slice(-2) + ":" +
            ("0" + time.getSeconds()).slice(-2) + "." +
            ("00" + time.getMilliseconds()).slice(-3);
        let entry = document.createElement('pre');
        entry.innerHTML = `<h1>${timeStr}</h1> ${msg}`;
        if (isError) entry.classList.add('logError');
        logContentElement.insertBefore(entry,logContentElement.childNodes[0]);
    }

    function updateTitle() {
        remote.getCurrentWindow().setTitle(
            ('[' + ((currentFilePath)? currentFilePath:'Untitled.j') + ']'+(dirty?' *':'')) +
            '   -   Volcano ' + formatVersion(rolling)
        );
    }

    function showConfirmSaveChangesDialog(yes,no,cancel) {
        showYesNoCancelDialog('Do you want to save the changes in current file?',yes,no,cancel);
    }

    function showAlert(msg,width) {
        let dlg = vex.dialog.alert({unsafeMessage:msg});
        if (width) {
            dlg.rootEl.querySelector('.vex-content').style.width = width;
        }
    }

    function showFileErrorAlert(msg,file) {
        let dlg = vex.dialog.confirm({
            unsafeMessage: msg,
            callback: ()=> {},
            buttons: [
                extend(vex.dialog.buttons.NO,{ text: 'Ok', click: function() {
                    vex.close(this.id.toString());
                }}),
                extend(vex.dialog.buttons.YES,{ text: 'Open file', click: function() {
                    remote.getGlobal('openFile')(file);
                    vex.close(this.id.toString());
                }}),
            ]
        });
        dlg.rootEl.querySelector('.vex-dialog-button-primary').focus();
    }

    function showYesNoCancelDialog(msg,yes,no,cancel) {
        let dlg = vex.dialog.confirm({
            unsafeMessage: msg,
            overlayClosesOnClick: false,
            callback: function () {
                let result = this.content.result;
                if (result!==undefined) {
                    if (result==='yes' && yes) yes();
                    else if (no) no();
                }
                else if (cancel) cancel();
            },
            buttons: [
                extend(vex.dialog.buttons.NO,{ text: 'Cancel', click: function() {
                    vex.close(this.id.toString());
                }}),
                extend(vex.dialog.buttons.NO,{ text: 'No', click: function() {
                    this.form.result = 'no';
                    vex.close(this.id.toString());
                }}),
                extend(vex.dialog.buttons.YES,{ text: 'Yes', click: function() {
                    this.form.result = 'yes';
                }}),
            ]
        });
        dlg.rootEl.querySelector('.vex-dialog-button-primary').focus();
    }

    function showYesNoDialog(msg,yes,no) {
        let dlg = vex.dialog.confirm({
            unsafeMessage: msg,
            overlayClosesOnClick: false,
            callback: function () {
                let result = this.content.result;
                if (result!==undefined) {
                    if (result==='yes' && yes) yes();
                    else if (no) no();
                }
                else if (no) no();
            },
            buttons: [
                extend(vex.dialog.buttons.NO,{ text: 'No', click: function() {
                    this.form.result = 'no';
                    vex.close(this.id.toString());
                }}),
                extend(vex.dialog.buttons.YES,{ text: 'Yes', click: function() {
                    this.form.result = 'yes';
                }}),
            ]
        });
        dlg.rootEl.querySelector('.vex-dialog-button-primary').focus();
    }

    function showLoadFileDialog(newwindow,callback) {
        function showOpenDialog(newwindow,callback){
            dialog.showOpenDialog(
                remote.getCurrentWindow(),
                {
                    filters: [
                        { extensions: ['j','class','jar'],  name:'All supported formats'},
                        { extensions: ['j'],        name:'Krakatau source'},
                        { extensions: ['class'],    name:'Java class'},
                        { extensions: ['jar'],      name:'Java jar'}
                    ],
                    properties:['multiSelections']
                },
                function (fileNames) {
                    if (fileNames) {
                        if (newwindow) {
                            fileNames.forEach((file)=>{
                                remote.getGlobal('openFile')(file);
                            });
                        }
                        else {
                            openFile(fileNames[0]);
                            if (fileNames.length > 1) {
                                for (let n = 1; n < fileNames.length; ++n) remote.getGlobal('openFile')(fileNames[n]);
                            }
                        }
                    }
                    if (callback) callback();
                }
            );
        }

        if (dirty && !newwindow){
            showConfirmSaveChangesDialog(
                ()=>{
                    if (currentFilePath) {
                        saveFile(currentFilePath);
                        showOpenDialog(newwindow, callback);
                    }
                    else {
                        showSaveFileDialog(()=>{
                           showOpenDialog(newwindow, callback);
                        });
                    }
                },
                ()=>{ showOpenDialog(newwindow, callback); }
            )
        }
        else showOpenDialog(newwindow, callback);

    }

    function showSaveFileDialog(callback) {
        dialog.showSaveDialog(
            remote.getCurrentWindow(),
            {
                filters: [
                    { extensions: ['j'],        name:'Krakatau source'}
                ],
                defaultPath: (currentFilePath)? currentFilePath:'Untitled.j'
            },
            function (fileName) {
                if (fileName) {
                    saveFile(fileName);
                    if (callback) callback();
                }
            }
        );
    }

    function showExtractFileDialog(callback) {
        dialog.showOpenDialog(
            remote.getCurrentWindow(),
            {
                filters: [
                    { extensions: ['jar'],      name:'Java jar'}
                ]
            },
            function (fileNames) {
                if (fileNames) {
                    dialog.showOpenDialog(
                        remote.getCurrentWindow(),
                        {
                            title: 'Select output folder (files may be overwritten)',
                            properties: ['openDirectory', 'createDirectory']
                        },
                        function (folderNames) {
                            if (folderNames) unjar(fileNames[0], folderNames[0], callback);
                        }
                    );
                }
            }
        );
    }

    function showAssembleFolderDialog(recursive, callback) {
        function doAsmFolderFromTo() {
            dialog.showOpenDialog(
                remote.getCurrentWindow(),
                {
                    title: 'Select folder to assemble' + (recursive? ' recursively':''),
                    properties: ['openDirectory']
                },
                function (inputFolderNames) {
                    if (inputFolderNames) {
                        dialog.showOpenDialog(
                            remote.getCurrentWindow(),
                            {
                                title: 'Select assembler output folder (class files may be overwritten)',
                                properties: ['openDirectory','createDirectory']
                            },
                            function (outputFolderNames) {
                                if (outputFolderNames) {
                                    assembleFolder(inputFolderNames[0], outputFolderNames[0], recursive);
                                    if (callback) callback();
                                }
                            }
                        );
                    }
                }
            );
        }
        if (dirty) {
            if (currentFilePath) {
                saveFile(currentFilePath);
                doAsmFolderFromTo();
            }
            else showSaveFileDialog(()=>{ if (currentFilePath) doAsmFolderFromTo(); });
        }
        else doAsmFolderFromTo();

    }

    function showDisassembleFolderDialog(recursive, callback) {
        function doDisAsm(inputDir,roundtrip,overwrite) {
            dialog.showOpenDialog(
                remote.getCurrentWindow(),
                {
                    title: 'Select disassembler output folder',
                    properties: ['openDirectory', 'createDirectory']
                },
                function (folderNames) {
                    if (folderNames) {
                        disassembleFolder(inputDir, folderNames[0], roundtrip, overwrite, recursive);
                        if (callback) callback();
                    }
                }
            );
        }

        function askOverwrite(inputDir,roundtrip) {
            showYesNoCancelDialog(
                'Do you want to overwrite files in the output folder?<br>' +
                '<span style="font-size:10px">If not, a timestamp suffix will be appended to filenames when necessary.</span>',
                ()=>{ doDisAsm(inputDir, roundtrip, true); },
                ()=>{ doDisAsm(inputDir, roundtrip, false); },
            );
        }


        dialog.showOpenDialog(
            remote.getCurrentWindow(),
            {
                title: 'Select disassembler input folder',
                properties: ['openDirectory']
            },
            function (folderNames) {
                if (folderNames) {
                    showYesNoCancelDialog(
                        'Do you want to use roundtrip mode? <br>' +
                        '<span style="font-size:10px">Roundtrip mode creates assembly files that are guaranteed to reassemble into the original binary, at the expense of being harder to read and edit.</span>',
                        ()=>{ askOverwrite(folderNames[0], true); },
                        ()=>{ askOverwrite(folderNames[0], false); },
                    );
                }
            }
        );
    }

    function openFile(fileName) {
        let fileType;
        if (fileName.toLowerCase().endsWith(".jar")) fileType = 'JAR';
        else if (fileName.toLowerCase().endsWith(".class")) fileType = 'CLASS';
        else if (fileName.toLowerCase().endsWith(".j")) fileType = 'SOURCE';

        if (fileType === 'CLASS' || fileType === 'JAR') {
            function doDisAsm(roundtrip,overwrite) {
                dialog.showOpenDialog(
                    remote.getCurrentWindow(),
                    {
                        title: 'Select disassembler output folder',
                        properties: ['openDirectory', 'createDirectory']
                    },
                    function (folderNames) {
                        if (folderNames) {
                            if (fileType === 'CLASS') disassemble(fileName, folderNames[0], roundtrip, overwrite);
                            else disassembleJar(fileName, folderNames[0], roundtrip, overwrite);
                        }
                    }
                );
            }

            function askOverwrite(roundtrip) {
                showYesNoCancelDialog(
                    'Do you want to overwrite files in the output folder?<br>' +
                    '<span style="font-size:10px">If not, a timestamp suffix will be appended to filenames when necessary.</span>',
                    ()=>{ doDisAsm(roundtrip,true); },
                    ()=>{ doDisAsm(roundtrip,false); },
                );
            }

            showYesNoCancelDialog(
                'This file has to be disassembled, do you want to use roundtrip mode? <br>' +
                '<span style="font-size:10px">Roundtrip mode creates assembly files that are guaranteed to reassemble into the original binary, at the expense of being harder to read and edit.</span>',
                ()=>{ askOverwrite(true); },
                ()=>{ askOverwrite(false); },
            );
        }
        else if (fileType === 'SOURCE') {
            loadFile(fileName);
        }
        else showAlert('Can not open that file');

    }

    function newFile(callback) {
        function clear(callback) {
            editor.off('change', setDirty);
            editor.setValue('');
            editor.clearHistory();
            editor.getMode().init();
            currentFilePath = undefined;
            currentOutputPath = undefined;
            clearDirty();
            updateTitle();
            onCursorActivity();
            editor.on('change', setDirty);
            if (callback) callback();
        }

        if (dirty){
            showConfirmSaveChangesDialog(
                ()=>{
                    if (currentFilePath) {
                        saveFile(currentFilePath);
                        clear(callback);
                    }
                    else {
                        showSaveFileDialog(()=>{
                            clear(callback);
                        });
                    }
                },
                ()=>{ clear(callback); }
            )
        }
        else clear(callback);

    }

    function loadFile(filePath) {
        editor.off('change',setDirty);
        findReplacePanel.close();
        try {
            if (fs.existsSync(filePath)) {
                let data = fs.readFileSync(filePath);
                editor.setValue(data.toString().replace(/\t/g,'    '));
                editor.clearHistory();
                currentFilePath = filePath;
                currentOutputPath = undefined;
                clearDirty();
                setStatusBarMessage(filePath +' > Loaded');
                updateTitle();
                onCursorActivity();
                editor.getMode().init();
            }
            else {
                showAlert(filePath + ' does not exist');
                if (debug) console.log('File [' + filePath + '] does not exist');
            }
        }
        catch(err) {
            showAlert(err);
            if (debug) console.log(err);
        }
        editor.on('change',setDirty);
    }

    function saveFile(filePath) {
        if (debug) console.log('Saving file: [' + filePath + ']');
        try {
            if (fs.existsSync(filePath)) {
                fs.truncateSync(filePath, 0);
            }
            fs.writeFileSync(filePath, editor.getValue(), function (err) {
                if (err) {
                    return showAlert("Error writing file: " + err);
                }
            });
            currentFilePath = filePath;
            clearDirty();
            setStatusBarMessage(currentFilePath + ' > Saved');
            updateTitle();
        }
        catch(err) {
            showAlert(err);
            if (debug) console.log(err);
        }
    }

    function disassemble(inputFile, outputDir, roundtrip, overwrite) {
        setStatusBarMessage(`${inputFile} > Disassembling`);
        try {
            const kWorker = new Worker('workers/kworker.js');
            workers.push(kWorker);
            kWorker.onmessage = (event)=> {
                if (event.data.success){
                    setStatusBarMessage( event.data.result + ' > Disassembled successfully');
                    loadFile(event.data.result);
                }
                else {
                    showAlert('Disassemble failed: ' + event.data.result);
                    setStatusBarMessage('Disassemble failed: ' + event.data.result, true);
                    if (debug) console.log(event.data.result);
                }
                kWorker.terminate();
                workers.splice(workers.indexOf(kWorker),1);
            };
            kWorker.postMessage({ op:'disassemble', inputFile:inputFile, outputDir:outputDir, roundtrip:roundtrip, overwrite:overwrite });

        } catch (e) {
            showAlert('Disassemble failed: ' + e.toString());
            setStatusBarMessage('Disassemble failed: ' + e.toString(), true);
            if (debug) console.log(e);
        }
    }

    function disassembleJar(inputFile, outputDir, roundtrip, overwrite, callback) {
        setStatusBarMessage(`${inputFile} > Processing`);
        try {
            const kWorker = new Worker('workers/kworker.js');
            workers.push(kWorker);
            kWorker.onmessage = (event)=> {
                if (event.data.close === true) {
                    kWorker.terminate();
                    workers.splice(workers.indexOf(kWorker),1);
                    if (event.data.success) {
                        setStatusBarMessage(`${inputFile} > Processed successfully`);
                        showAlert(`${inputFile} processed successfully`);
                    }
                    else {
                        setStatusBarMessage(event.data.result, true);
                        setStatusBarMessage(`${inputFile} > Processed with errors`, true);
                        showAlert(`${inputFile} processed with errors`);
                    }
                    if (callback) callback(!event.data.success);
                }
                else {
                    if (event.data.success) setStatusBarMessage(`[${event.data.processed} of ${event.data.total}] ${event.data.result} > Disassembled`);
                    else setStatusBarMessage(event.data.result, true);
                }
            };
            kWorker.postMessage({ op:'disassembleJar', inputFile:inputFile, outputDir:outputDir, roundtrip:roundtrip, overwrite:overwrite });
        }
        catch (e) {
            showAlert('Disassemble failed: ' + e.toString());
            setStatusBarMessage('Disassemble failed: ' + e.toString(), true);
            if (debug) console.log(e);
        }
    }

    function unjar(inputFile, outputDir, callback) {
        setStatusBarMessage(`${inputFile} > Processing`);
        try {
            const kWorker = new Worker('workers/kworker.js');
            workers.push(kWorker);
            kWorker.onmessage = (event)=> {
                if (event.data.close === true) {
                    kWorker.terminate();
                    workers.splice(workers.indexOf(kWorker),1);
                    if (event.data.success) {
                        setStatusBarMessage(`${inputFile} > Processed successfully`);
                        showAlert(`${inputFile} processed successfully`);
                    }
                    else {
                        setStatusBarMessage(event.data.result, true);
                        setStatusBarMessage(`${inputFile} > Processed with errors`, true);
                        showAlert(`${inputFile} processed with errors`);
                    }
                    if (callback) callback(!event.data.success);
                }
                else {
                    if (event.data.success) setStatusBarMessage(`[${event.data.processed} of ${event.data.total}] ${event.data.result} > Extracted`);
                    else setStatusBarMessage(event.data.result, true);
                }
            };
            kWorker.postMessage({ op:'unjar', inputFile:inputFile, outputDir:outputDir });
        }
        catch (e) {
            showAlert('Unjar failed: ' + e.toString());
            setStatusBarMessage('Unjar failed: ' + e.toString(), true);
            if (debug) console.log(e);
        }
    }

    function assemble(inputFile, outputDir) {
        setStatusBarMessage(`${inputFile} > Processing`);
        try {
            const kWorker = new Worker('workers/kworker.js');
            workers.push(kWorker);
            kWorker.onmessage = (event)=>{
                if (event.data.success) {
                    const assembled = event.data.result;
                    let  okCount = 0, hadError = false;
                    assembled.forEach((cls)=>{
                        if (cls.success) {
                            okCount++;
                            setStatusBarMessage(cls.outputFile + ' > Assembled');
                        }
                        else {
                            hadError = true;
                            const eh = escapeHTML;
                            const {line, col, message, snippet, markers} = cls.error;
                            let ghtml = `${eh(message)}<pre>\n${eh(snippet)}\n${eh(markers)}\n</pre>`;
                            let html = `${line}:${col} error: ${ghtml}`;
                            editor.scrollIntoView({line:line, ch:col});
                            editor.getMode().addAssemblerError(line-1, ghtml);
                            showAlert(html);
                            setStatusBarMessage(html, true);
                            setStatusBarMessage('Assemble failed', true);
                        }
                    });
                    if (okCount > 0) {
                        let msg = `${okCount} classes assembled successfully`;
                        if (hadError) msg += ', but file contains errors';
                        showAlert(msg);
                        setStatusBarMessage(`${inputFile} > Processed, ${msg}`, hadError);
                    }
                }
                else {
                    showAlert('Assemble failed: ' + event.data.result);
                    setStatusBarMessage('Assemble failed: ' + event.data.result, true);
                    if (debug) console.log(event.data.result);
                }
                kWorker.terminate();
                workers.splice(workers.indexOf(kWorker),1);
            };
            kWorker.postMessage({ op:'assemble', inputFile:inputFile, outputDir:outputDir });

        }
        catch (e) {
            showAlert('Assemble failed: ' + e.toString());
            setStatusBarMessage('Assemble failed: ' + e.toString(), true);
            if (debug) console.log(e);
        }
    }

    function assembleFolder(inputDir, outputDir, recursive) {
        setStatusBarMessage(`${inputDir} > Processing folder`);
        try {
            const kWorker = new Worker('workers/kworker.js');
            workers.push(kWorker);
            kWorker.onmessage = (event)=> {
                if (event.data.close === true) {
                    kWorker.terminate();
                    workers.splice(workers.indexOf(kWorker),1);
                    showAlert(`${event.data.classes} classes (${event.data.total} source files) assembled successfully`);
                    setStatusBarMessage(`${inputDir} > Folder processed succesfully (${event.data.total} source files / ${event.data.total} classes)`);
                }
                else if (event.data.success) {
                    setStatusBarMessage(event.data.result + ' > Assembled');
                }
                else if (event.data.error) {
                    const eh = escapeHTML;
                    const {line, col, message, snippet, markers} = event.data.error;
                    let errorMsg = `${event.data.result}<br>${line}:${col} error: ${eh(message)}<pre>\n${eh(snippet)}\n${eh(markers)}\n</pre>`;
                    showFileErrorAlert(errorMsg,event.data.result);
                    setStatusBarMessage(errorMsg, true);
                    setStatusBarMessage(`${inputDir} > Folder not fully processed (only ${event.data.total} source files), there was errors`, true);
                    kWorker.terminate();
                    workers.splice(workers.indexOf(kWorker),1);
                }
                else {
                    showAlert('Assemble folder failed: ' + event.data.result);
                    setStatusBarMessage('Assemble folder failed: ' + event.data.result, true);
                    kWorker.terminate();
                    workers.splice(workers.indexOf(kWorker),1);
                }
            };
            kWorker.postMessage({ op:'assembleFolder', inputDir:inputDir, outputDir:outputDir, recursive:recursive });
        } catch (e) {
            showAlert('Assemble folder failed: ' + e.toString());
            setStatusBarMessage('Assemble folder failed: ' + e.toString(), true);
            if (debug) console.log(e);
        }
    }

    function disassembleFolder(inputDir, outputDir, roundtrip, overwrite, recursive) {
        setStatusBarMessage(`${inputDir} > Processing folder`);
        try {
            const kWorker = new Worker('workers/kworker.js');
            workers.push(kWorker);
            kWorker.onmessage = (event)=> {
                if (event.data.close === true) {
                    kWorker.terminate();
                    workers.splice(workers.indexOf(kWorker),1);
                    if (!event.data.success) {
                        showAlert('Unexpected error, see log');
                        setStatusBarMessage(event.data.result, true);
                    }
                    if (event.data.errors > 0) {
                        showAlert(`${inputDir} folder processed with errors (${event.data.total} class files / ${event.data.errors} errors)`);
                        setStatusBarMessage(`${inputDir} > Folder processed with errors (${event.data.total} class files / ${event.data.errors} errors)`);
                    }
                    else {
                        showAlert(`${inputDir} folder processed succesfully (${event.data.total} class files)`);
                        setStatusBarMessage(`${inputDir} > Folder processed succesfully (${event.data.total} class files)`);
                    }
                }
                else if (event.data.success) {
                    setStatusBarMessage(event.data.result + ' > Disassembled');
                }
                else {
                    setStatusBarMessage(`${event.data.file} > ${event.data.result}`, true);
                }
            };
            kWorker.postMessage({ op:'disassembleFolder', inputDir:inputDir, outputDir:outputDir, roundtrip:roundtrip, overwrite:overwrite, recursive:recursive });
        } catch (e) {
            showAlert('Disassemble folder failed: ' + e.toString());
            setStatusBarMessage('Disassemble folder failed: ' + e.toString(), true);
            if (debug) console.log(e);
        }
    }

    function clearErrorGutterOnEmptyLines() {
        clearTimeout(changeTimer);
        changeTimer = setTimeout(()=>{
            let lineNumber = editor.getCursor().line;
            if (editor.getLine(lineNumber).length === 0) {

                editor.getMode().removeErrorGutterFromLine(lineNumber);
            }
        },500);

    }

    function onCursorActivity() {
        let pos = editor.getCursor();
        textposElement.innerText = (pos.line + 1) + ':' + (pos.ch + 1);
    }

    function onCloseQuery() {
        if (dirty) {
            showConfirmSaveChangesDialog(
                ()=>{
                    if (currentFilePath) {
                        saveFile(currentFilePath);
                        remote.getCurrentWindow().close();
                    }
                    else {
                        showSaveFileDialog(()=>{
                            remote.getCurrentWindow().close();
                        });
                    }
                },
                ()=>{ dirty = false; remote.getCurrentWindow().close(); }
            );
            return false;
        }
        else return null;
    }

    function downloadToString(url, onsuccess, onerror, num) {
        if ( num > 10 ) {
            if (debug) console.log( 'Too many redirects' );
            onerror(-1);
        }
        let request = https.get(url + '?' + (new Date()).getTime(), (res) => {
            switch(res.statusCode) {
                case 200: break;
                case 302: downloadToString(res.headers.location + '?' + (new Date()).getTime(), onsuccess, onerror, num + 1); return;
                default: request.abort(); onerror(res.statusCode); return;
            }
            let data = '';
            res.on('end',()=>{ onsuccess(data); });
            res.on('data', (d) => { data+=d; });
        }).on('error', (e) => { onerror(e) });
    }

    function downloadToFile(remote, local, onsuccess, onerror, num) {
        if ( num > 10 ) {
            if (debug) console.log( 'Too many redirects' );
            onerror(-1);
        }
        let new_remote = null;
        let write_file_ready = false;
        let content_length;
        let write_file;
        let downloaded_bytes = 0;
        let percent;

        let request = https.get(remote + '?' + (new Date()).getTime(), (response) => {
            switch(response.statusCode) {
                case 200:
                    content_length = response.headers['content-length'];
                    if (debug) console.log('content-length: ' + content_length);
                    break;
                case 302:
                    new_remote = response.headers.location + '?' + (new Date()).getTime();
                    downloadToFile(new_remote, local, onsuccess, onerror, num+1 );
                    return;
                default:
                    request.abort();
                    onerror(response.statusCode);
                    return;
            }
            response.on('end', () => { write_file.end(onsuccess); });
            response.on('data', (chunk) => {
                if(!write_file_ready) {
                    write_file = fs.createWriteStream(local);
                    write_file_ready = true;
                }
                write_file.write(chunk);
                downloaded_bytes+=chunk.length;
                percent = parseInt( (downloaded_bytes/content_length)*100 );
                if (debug) console.log( percent );
            });
        });
        request.on('error', (e) => { onerror(e); });
    }

    function checkForUpdates(quiet) {

        function printGenericError() {
            showAlert('Sorry, there was a problem, try later please.');
            setStatusBarMessage('Update failed, try later.', true);
        }

        function printNetworkError() {
            showAlert('Sorry, there was a network error, check your connection and/or try later.');
            setStatusBarMessage('Network error, update failed, check your connection and/or try later.', true);
        }


        if (!quiet) setStatusBarMessage('Checking for updates...');

        downloadToString(updateURL + 'latest',
            (data)=>{
                let latest = data.split('\n');
                if (latest.length>1){
                    let latestRolling = parseInt(latest[0]);
                    if (!isNaN(latestRolling)) {
                        if (latestRolling > rolling) {
                            let patchFile = latest[1].replace(/(\r\n|\n|\r)/gm,'');
                            if (patchFile.startsWith('#PATCH#')) {
                                patchFile = patchFile.replace('#PATCH#','');
                                showYesNoDialog(
                                    'Update available, do you want to download them now?', () => {
                                        let installFolder = path.dirname(process.argv[0]);
                                        let resourcesFolder = path.resolve(installFolder, 'resources');
                                        let patchPath = path.resolve(resourcesFolder, patchFile);
                                        downloadToFile(
                                            updateURL + patchFile,
                                            patchPath,
                                            () => {
                                                showYesNoDialog(
                                                    'Must restart to apply updates, do you want to restart now?', () => {
                                                        remote.getGlobal('restart')();
                                                    });
                                            },
                                            (err) => {
                                                if (debug) console.log(err);
                                                printNetworkError();
                                            }
                                        );
                                    }
                                );
                            }
                            else showAlert(patchFile);
                        }
                        else if (!quiet) {
                            showAlert('Volcano is up to date!');
                            setStatusBarMessage('Volcano is up to date!');
                        }
                    }
                    else if (!quiet) printGenericError();
                }
                else  if (!quiet) printGenericError();
            },
            (error)=>{
                if (!quiet) printNetworkError();
                if (debug) console.log(error);
            }
        );
    }

    function toggleLog() {
        if (logElement.style.display !== 'block') {
            logElement.style.display = 'block';
            showLogIconElement.classList.remove('fa-arrow-circle-o-up');
            showLogIconElement.classList.add('fa-arrow-circle-o-down');
            showLogIconElement.title = 'Hide log';
        }
        else {
            logElement.style.display = 'none';
            showLogIconElement.classList.remove('fa-arrow-circle-o-down');
            showLogIconElement.classList.add('fa-arrow-circle-o-up');
            showLogIconElement.title = 'Show log';
        }
    }

    function clearLog() {
        logContentElement.querySelectorAll('pre').forEach(el=>{el.remove()});
        toggleLog();
    }


    window.onbeforeunload = onCloseQuery;

    vex.defaultOptions.className = 'vex-theme-volcano';

    remote.getCurrentWindow().setMenu(menu);

    editor.setOption('theme', 'volcano');

    editor.on('change',clearErrorGutterOnEmptyLines);

    editor.on('cursorActivity',onCursorActivity);

    editor.on('contextmenu', () => {
        contextMenu.popup(remote.getCurrentWindow());
    });

    document.ondragover = document.ondrop = (ev) => {
        ev.preventDefault()
    };

    document.body.ondrop = (ev) => {
        if (debug) console.log(ev.dataTransfer.files);
        ev.preventDefault();
        if (ev.dataTransfer.files.length > 0) {
            openFile(ev.dataTransfer.files[0].path);
            if (ev.dataTransfer.files.length > 1) {
                for (let n = 1; n < ev.dataTransfer.files.length; ++n)
                    remote.getGlobal('openFile')(ev.dataTransfer.files[n].path);
            }
        }
    };

    setInterval(()=>{
        if (remote.getGlobal('isMainWindow')(remote.getCurrentWindow())) checkForUpdates(true);
    },3600000);

    newFile();

    if (argFile) openFile(argFile);

    if (remote.getGlobal('isMainWindow')(remote.getCurrentWindow())) checkForUpdates(true);

</script>
</html>
